{% extends "base.html" %}
{% block active_cicd %}active{% endblock %}
{% block title %}CI/CD - 质量安全平台{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="page-title">CI/CD 流水线</h1>
    <button class="btn btn-gradient"><i class="fas fa-play me-2"></i>触发构建</button>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="glass-card p-4">
            <h5 class="section-title">最近构建</h5>
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>构建ID</th>
                        <th>流水线</th>
                        <th>版本</th>
                        <th>状态</th>
                        <th>耗时</th>
                        <th>触发人</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="buildTableBody"></tbody>
            </table>
        </div>
    </div>
    <div class="col-md-4">
        <div class="glass-card p-4">
            <h5 class="section-title">流水线状态</h5>
            <canvas id="pipelineChart" style="height: 200px;"></canvas>
            <div class="mt-3">
                <div class="d-flex justify-content-between">
                    <span>成功率</span>
                    <span class="fw-bold" id="successRate">0%</span>
                </div>
                <div class="progress mt-1 mb-3" style="height: 8px;">
                    <div class="progress-bar bg-success" id="successBar" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
async function fetchBuilds() {
    try {
        const res = await fetch('/api/cicd/build-history/', { credentials: 'include' });
        const data = await res.json();
        const builds = data.status === 'success' ? data.builds : [];
        renderBuilds(builds);
        calculateStats(builds);
    } catch (error) {
        console.error('获取构建历史失败:', error);
        // 模拟构建数据
        const mockBuilds = [
            { id: 1, pipeline_name: '测试流水线 1', version: 'v1.0.0', status: 'success', duration: 120, triggered_by_username: 'admin' },
            { id: 2, pipeline_name: '测试流水线 2', version: 'v1.1.0', status: 'failed', duration: 90, triggered_by_username: 'user1' },
            { id: 3, pipeline_name: '测试流水线 1', version: 'v1.2.0', status: 'running', duration: 60, triggered_by_username: 'admin' }
        ];
        renderBuilds(mockBuilds);
        calculateStats(mockBuilds);
    }
}

function renderBuilds(builds) {
    const tbody = document.getElementById('buildTableBody');
    tbody.innerHTML = '';
    builds.slice(0, 10).forEach(b => {
        let statusClass, statusText;
        switch(b.status) {
            case 'success':
                statusClass = 'bg-success';
                statusText = '成功';
                break;
            case 'failed':
                statusClass = 'bg-danger';
                statusText = '失败';
                break;
            case 'running':
                statusClass = 'bg-warning';
                statusText = '运行中';
                break;
            case 'pending':
                statusClass = 'bg-secondary';
                statusText = '等待中';
                break;
            case 'aborted':
                statusClass = 'bg-info';
                statusText = '终止';
                break;
            default:
                statusClass = 'bg-secondary';
                statusText = b.status;
        }
        const duration = b.duration ? `${Math.floor(b.duration/60)}m${b.duration%60}s` : '—';
        tbody.innerHTML += `
            <tr>
                <td><code>#${b.id}</code></td>
                <td>${b.pipeline_name || '未知'}</td>
                <td>${b.version}</td>
                <td><span class="badge ${statusClass}">${statusText}</span></td>
                <td>${duration}</td>
                <td>${b.triggered_by_username || '—'}</td>
                <td><a href="#">详情</a></td>
            </tr>
        `;
    });
}

function calculateStats(builds) {
    const total = builds.length;
    const success = builds.filter(b => b.status === 'success').length;
    const rate = total ? (success / total * 100).toFixed(1) : 0;
    document.getElementById('successRate').textContent = rate + '%';
    document.getElementById('successBar').style.width = rate + '%';
    const ctx = document.getElementById('pipelineChart').getContext('2d');
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['成功', '失败'],
            datasets: [{
                data: [success, total - success],
                backgroundColor: ['#198754', '#dc3545'],
                borderWidth: 0
            }]
        },
        options: { cutout: '70%', plugins: { legend: { display: false } } }
    });
}

fetchBuilds();
</script>
{% endblock %}