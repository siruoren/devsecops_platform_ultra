{% extends "base.html" %}
{% block active_users %}active{% endblock %}
{% block title %}用户管理 - 质量安全平台{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="page-title">用户管理</h1>
    <button class="btn btn-gradient" data-bs-toggle="modal" data-bs-target="#userModal" onclick="clearForm()"><i class="fas fa-plus me-2"></i>新建用户</button>
</div>

<!-- 搜索栏 -->
<div class="glass-card p-3 mb-4">
    <div class="row g-3">
        <div class="col-md-4">
            <div class="input-group">
                <span class="input-group-text bg-white"><i class="fas fa-search"></i></span>
                <input type="text" id="searchInput" class="form-control" placeholder="用户名/邮箱/部门" onkeyup="fetchUsers()">
            </div>
        </div>
        <div class="col-md-2">
            <select id="statusFilter" class="form-select" onchange="fetchUsers()">
                <option value="">全部状态</option>
                <option value="true">激活</option>
                <option value="false">未激活</option>
            </select>
        </div>
        <div class="col-md-2">
            <button class="btn btn-outline-primary" onclick="fetchUsers()">查询</button>
            <button class="btn btn-outline-secondary ms-2" onclick="resetFilters()">重置</button>
        </div>
    </div>
</div>

<!-- 用户列表 -->
<div class="glass-card p-4">
    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead>
                <tr>
                    <th>用户</th>
                    <th>邮箱</th>
                    <th>部门</th>
                    <th>职位</th>
                    <th>角色</th>
                    <th>状态</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="userTableBody">
                <!-- 动态填充 -->
            </tbody>
        </table>
    </div>
    <!-- 分页 -->
    <nav class="mt-3">
        <ul class="pagination justify-content-end" id="pagination">
            <!-- 动态生成 -->
        </ul>
    </nav>
</div>

<!-- 用户表单模态框 -->
<div class="modal fade" id="userModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">新建用户</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <input type="hidden" id="userId">
                    <div class="mb-3">
                        <label class="form-label">用户名</label>
                        <input type="text" id="username" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">邮箱</label>
                        <input type="email" id="email" class="form-control" required>
                    </div>
                    <div class="mb-3" id="passwordField">
                        <label class="form-label">密码</label>
                        <input type="password" id="password" class="form-control" minlength="8">
                    </div>
                    <div class="row mb-3">
                        <div class="col">
                            <label class="form-label">姓</label>
                            <input type="text" id="lastName" class="form-control">
                        </div>
                        <div class="col">
                            <label class="form-label">名</label>
                            <input type="text" id="firstName" class="form-control">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">部门</label>
                        <input type="text" id="department" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">职位</label>
                        <input type="text" id="position" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">手机号</label>
                        <input type="text" id="phone" class="form-control">
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" id="isActive" class="form-check-input" checked>
                        <label class="form-check-label">激活</label>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" id="isSuperuser" class="form-check-input">
                        <label class="form-check-label">超级管理员</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveUser()">保存</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentPage = 1;
let pageSize = 10;
let totalPages = 1;

async function fetchUsers() {
    const search = document.getElementById('searchInput').value;
    const isActive = document.getElementById('statusFilter').value;
    let url = `/api/users/?page=${currentPage}&page_size=${pageSize}`;
    if (search) url += `&search=${encodeURIComponent(search)}`;
    if (isActive !== '') url += `&is_active=${isActive}`;

    try {
        const res = await fetch(url, { credentials: 'include' });
        const data = await res.json();
        const users = data.results || data;
        const count = data.count || users.length;
        totalPages = Math.ceil(count / pageSize);
        renderUsers(users);
        renderPagination();
    } catch (err) {
        console.error('获取用户失败', err);
    }
}

function renderUsers(users) {
    const tbody = document.getElementById('userTableBody');
    tbody.innerHTML = '';
    users.forEach(u => {
        const roleBadge = u.is_superuser ? 'bg-primary' : 'bg-secondary';
        const roleText = u.is_superuser ? '超级管理员' : '普通用户';
        const statusBadge = u.is_active ? 'bg-success' : 'bg-warning text-dark';
        const statusText = u.is_active ? '激活' : '未激活';
        tbody.innerHTML += `
            <tr>
                <td>
                    <div class="d-flex align-items-center">
                        <span class="avatar me-2" style="background: ${getAvatarColor(u.username)};">${getInitials(u.username)}</span>
                        <span>${u.username}</span>
                    </div>
                </td>
                <td>${u.email}</td>
                <td>${u.department || '—'}</td>
                <td>${u.position || '—'}</td>
                <td><span class="badge ${roleBadge}">${roleText}</span></td>
                <td><span class="badge ${statusBadge}">${statusText}</span></td>
                <td>
                    <button class="btn btn-sm btn-outline-secondary me-1" onclick="editUser(${u.id})"><i class="fas fa-edit"></i></button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteUser(${u.id})"><i class="fas fa-trash"></i></button>
                </td>
            </tr>
        `;
    });
}

function getInitials(username) {
    return username.substring(0, 2).toUpperCase();
}
function getAvatarColor(username) {
    const colors = ['#0d6efd', '#6f42c1', '#20c997', '#fd7e14', '#dc3545', '#198754'];
    const hash = username.split('').reduce((a, b) => a + b.charCodeAt(0), 0);
    return colors[hash % colors.length];
}

function renderPagination() {
    const pagination = document.getElementById('pagination');
    pagination.innerHTML = '';
    pagination.innerHTML += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}"><a class="page-link" href="#" onclick="changePage(${currentPage-1})">上一页</a></li>`;
    for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage-2 && i <= currentPage+2)) {
            pagination.innerHTML += `<li class="page-item ${i === currentPage ? 'active' : ''}"><a class="page-link" href="#" onclick="changePage(${i})">${i}</a></li>`;
        } else if (i === currentPage-3 || i === currentPage+3) {
            pagination.innerHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
    }
    pagination.innerHTML += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}"><a class="page-link" href="#" onclick="changePage(${currentPage+1})">下一页</a></li>`;
}

function changePage(page) {
    if (page < 1 || page > totalPages) return;
    currentPage = page;
    fetchUsers();
}

function resetFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('statusFilter').value = '';
    currentPage = 1;
    fetchUsers();
}

function clearForm() {
    document.getElementById('userId').value = '';
    document.getElementById('username').value = '';
    document.getElementById('email').value = '';
    document.getElementById('password').value = '';
    document.getElementById('firstName').value = '';
    document.getElementById('lastName').value = '';
    document.getElementById('department').value = '';
    document.getElementById('position').value = '';
    document.getElementById('phone').value = '';
    document.getElementById('isActive').checked = true;
    document.getElementById('isSuperuser').checked = false;
    document.getElementById('passwordField').style.display = 'block';
    document.getElementById('modalTitle').textContent = '新建用户';
}

function editUser(id) {
    fetch(`/api/users/${id}/`, { credentials: 'include' })
        .then(res => res.json())
        .then(user => {
            document.getElementById('userId').value = user.id;
            document.getElementById('username').value = user.username;
            document.getElementById('email').value = user.email;
            document.getElementById('firstName').value = user.first_name || '';
            document.getElementById('lastName').value = user.last_name || '';
            document.getElementById('department').value = user.department || '';
            document.getElementById('position').value = user.position || '';
            document.getElementById('phone').value = user.phone || '';
            document.getElementById('isActive').checked = user.is_active;
            document.getElementById('isSuperuser').checked = user.is_superuser;
            document.getElementById('passwordField').style.display = 'none';
            document.getElementById('modalTitle').textContent = '编辑用户';
            new bootstrap.Modal(document.getElementById('userModal')).show();
        })
        .catch(err => console.error('获取用户详情失败', err));
}

function saveUser() {
    const id = document.getElementById('userId').value;
    const data = {
        username: document.getElementById('username').value,
        email: document.getElementById('email').value,
        first_name: document.getElementById('firstName').value,
        last_name: document.getElementById('lastName').value,
        department: document.getElementById('department').value,
        position: document.getElementById('position').value,
        phone: document.getElementById('phone').value,
        is_active: document.getElementById('isActive').checked,
        is_superuser: document.getElementById('isSuperuser').checked,
    };
    if (!id) {
        data.password = document.getElementById('password').value;
        if (!data.password) {
            alert('密码不能为空');
            return;
        }
    }
    const url = id ? `/api/users/${id}/` : '/api/users/';
    const method = id ? 'PUT' : 'POST';

    fetch(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
        credentials: 'include'
    })
    .then(res => {
        if (res.ok) {
            bootstrap.Modal.getInstance(document.getElementById('userModal')).hide();
            fetchUsers();
        } else {
            res.json().then(err => alert('保存失败: ' + JSON.stringify(err)));
        }
    })
    .catch(err => console.error('保存用户失败', err));
}

function deleteUser(id) {
    if (!confirm('确认删除该用户吗？')) return;
    fetch(`/api/users/${id}/`, {
        method: 'DELETE',
        credentials: 'include'
    })
    .then(res => {
        if (res.ok) {
            fetchUsers();
        } else {
            alert('删除失败');
        }
    })
    .catch(err => console.error('删除用户失败', err));
}

fetchUsers();
</script>
{% endblock %}