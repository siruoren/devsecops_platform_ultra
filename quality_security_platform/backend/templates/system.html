{% extends "base.html" %}
{% block active_system %}active{% endblock %}
{% block title %}系统管理 - 质量安全平台{% endblock %}
{% block content %}
<h1 class="page-title mb-4">系统管理</h1>

<div class="row">
    <div class="col-md-6">
        <div class="glass-card p-4 mb-4">
            <h5 class="section-title"><i class="fas fa-envelope me-2"></i>邮件服务器</h5>
            <div class="mb-3">
                <label class="form-label">SMTP 服务器</label>
                <input type="text" id="smtpServer" class="form-control">
            </div>
            <div class="row mb-3">
                <div class="col">
                    <label class="form-label">端口</label>
                    <input type="text" id="smtpPort" class="form-control">
                </div>
                <div class="col">
                    <label class="form-label">加密</label>
                    <select id="smtpEncryption" class="form-select">
                        <option value="tls">TLS</option>
                        <option value="ssl">SSL</option>
                        <option value="none">无</option>
                    </select>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">用户名</label>
                <input type="text" id="smtpUsername" class="form-control">
            </div>
            <div class="mb-3">
                <label class="form-label">密码</label>
                <input type="password" id="smtpPassword" class="form-control">
            </div>
            <div class="mb-3">
                <label class="form-label">发送人邮箱</label>
                <input type="email" id="senderEmail" class="form-control">
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="glass-card p-4 mb-4">
            <h5 class="section-title"><i class="fas fa-bell me-2"></i>消息限额</h5>
            <div class="mb-3">
                <label class="form-label">每日最大站内信 (每用户)</label>
                <input type="number" id="maxMessages" class="form-control">
            </div>
            <div class="mb-3">
                <label class="form-label">每日最大邮件发送量</label>
                <input type="number" id="maxEmails" class="form-control">
            </div>
        </div>

        <div class="glass-card p-4">
            <h5 class="section-title"><i class="fas fa-database me-2"></i>数据库连接</h5>
            <div class="mb-3">
                <label class="form-label">主机</label>
                <input type="text" id="dbHost" class="form-control">
            </div>
            <div class="row mb-3">
                <div class="col">
                    <label class="form-label">端口</label>
                    <input type="text" id="dbPort" class="form-control">
                </div>
                <div class="col">
                    <label class="form-label">库名</label>
                    <input type="text" id="dbName" class="form-control">
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-2">
    <div class="col-12">
        <div class="glass-card p-4">
            <div class="d-flex justify-content-end">
                <button class="btn btn-gradient px-5" onclick="saveConfig()">保存配置</button>
            </div>
        </div>
    </div>
</div>

<script>
async function loadConfig() {
    // 假设有 /api/system/config/ 接口
    try {
        const res = await fetch('/api/system/config/', { credentials: 'include' });
        const config = await res.json();
        document.getElementById('smtpServer').value = config.smtp_server || '';
        document.getElementById('smtpPort').value = config.smtp_port || 587;
        document.getElementById('smtpEncryption').value = config.smtp_encryption || 'tls';
        document.getElementById('smtpUsername').value = config.smtp_username || '';
        document.getElementById('senderEmail').value = config.sender_email || '';
        document.getElementById('maxMessages').value = config.max_daily_messages || 100;
        document.getElementById('maxEmails').value = config.max_daily_emails || 500;
        document.getElementById('dbHost').value = config.db_host || 'localhost';
        document.getElementById('dbPort').value = config.db_port || 5432;
        document.getElementById('dbName').value = config.db_name || 'qsp';
    } catch (err) {
        console.error('加载配置失败', err);
    }
}

function saveConfig() {
    const data = {
        smtp_server: document.getElementById('smtpServer').value,
        smtp_port: parseInt(document.getElementById('smtpPort').value),
        smtp_encryption: document.getElementById('smtpEncryption').value,
        smtp_username: document.getElementById('smtpUsername').value,
        smtp_password: document.getElementById('smtpPassword').value,
        sender_email: document.getElementById('senderEmail').value,
        max_daily_messages: parseInt(document.getElementById('maxMessages').value),
        max_daily_emails: parseInt(document.getElementById('maxEmails').value),
        db_host: document.getElementById('dbHost').value,
        db_port: parseInt(document.getElementById('dbPort').value),
        db_name: document.getElementById('dbName').value,
    };
    fetch('/api/system/config/', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
        credentials: 'include'
    })
    .then(res => {
        if (res.ok) alert('保存成功');
        else alert('保存失败');
    })
    .catch(err => console.error(err));
}

loadConfig();
</script>
{% endblock %}