{% extends "base.html" %}
{% block active_system %}active{% endblock %}
{% block title %}系统管理 - 质量安全平台{% endblock %}
{% block content %}
<h1 class="page-title mb-4">系统管理</h1>

<div class="row">
    <div class="col-md-6">
        <div class="glass-card p-4 mb-4">
            <h5 class="section-title"><i class="fas fa-envelope me-2"></i>邮件服务器</h5>
            <div class="mb-3">
                <label class="form-label">SMTP 服务器</label>
                <input type="text" id="smtpServer" class="form-control">
            </div>
            <div class="row mb-3">
                <div class="col">
                    <label class="form-label">端口</label>
                    <input type="text" id="smtpPort" class="form-control">
                </div>
                <div class="col">
                    <label class="form-label">加密</label>
                    <select id="smtpEncryption" class="form-select">
                        <option value="tls">TLS</option>
                        <option value="ssl">SSL</option>
                        <option value="none">无</option>
                    </select>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">用户名</label>
                <input type="text" id="smtpUsername" class="form-control">
            </div>
            <div class="mb-3">
                <label class="form-label">密码</label>
                <input type="password" id="smtpPassword" class="form-control">
            </div>
            <div class="mb-3">
                <label class="form-label">发送人邮箱</label>
                <input type="email" id="senderEmail" class="form-control">
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="glass-card p-4 mb-4">
            <h5 class="section-title"><i class="fas fa-bell me-2"></i>消息限额</h5>
            <div class="mb-3">
                <label class="form-label">每日最大站内信 (每用户)</label>
                <input type="number" id="maxMessages" class="form-control">
            </div>
            <div class="mb-3">
                <label class="form-label">每日最大邮件发送量</label>
                <input type="number" id="maxEmails" class="form-control">
            </div>
        </div>

        <div class="glass-card p-4">
            <h5 class="section-title"><i class="fas fa-database me-2"></i>数据库连接</h5>
            <div class="mb-3">
                <label class="form-label">主机</label>
                <input type="text" id="dbHost" class="form-control">
            </div>
            <div class="row mb-3">
                <div class="col">
                    <label class="form-label">端口</label>
                    <input type="text" id="dbPort" class="form-control">
                </div>
                <div class="col">
                    <label class="form-label">库名</label>
                    <input type="text" id="dbName" class="form-control">
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-2">
    <div class="col-md-6">
        <div class="glass-card p-4 mb-4">
            <h5 class="section-title"><i class="fas fa-globe me-2"></i>网站设置</h5>
            <div class="mb-3">
                <label class="form-label">页面标题</label>
                <input type="text" id="pageTitle" class="form-control">
            </div>
            <div class="mb-3">
                <label class="form-label">网站名称</label>
                <input type="text" id="siteName" class="form-control">
            </div>
            <div class="mb-3">
                <label class="form-label">网站描述</label>
                <textarea id="siteDescription" class="form-control" rows="3"></textarea>
            </div>
        </div>

        <div class="glass-card p-4 mb-4">
            <h5 class="section-title"><i class="fas fa-palette me-2"></i>网站主题</h5>
            <div class="mb-3">
                <label class="form-label">主色调</label>
                <input type="color" id="primaryColor" class="form-control form-control-color">
            </div>
            <div class="mb-3">
                <label class="form-label">次要色调</label>
                <input type="color" id="secondaryColor" class="form-control form-control-color">
            </div>
            <div class="mb-3">
                <label class="form-label">背景颜色</label>
                <input type="color" id="backgroundColor" class="form-control form-control-color">
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="glass-card p-4 mb-4">
            <h5 class="section-title"><i class="fas fa-image me-2"></i>企业图标</h5>
            <div class="mb-3">
                <label class="form-label">上传图标</label>
                <input type="file" id="logoFile" class="form-control" accept="image/*">
            </div>
            <div class="mb-3">
                <img id="logoPreview" src="" alt="企业图标预览" class="img-thumbnail" style="max-width: 200px; display: none;">
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-primary" onclick="uploadLogo()">上传</button>
                <button class="btn btn-secondary" onclick="resetLogo()">重置</button>
            </div>
        </div>
    </div>
</div>

<div class="row mt-2">
    <div class="col-12">
        <div class="glass-card p-4">
            <div class="d-flex justify-content-end">
                <button class="btn btn-gradient px-5" onclick="saveConfig()">保存配置</button>
            </div>
        </div>
    </div>
</div>

<script>
async function loadConfig() {
    try {
        // 添加时间戳参数，禁用缓存
        const timestamp = new Date().getTime();
        const res = await fetch(`/api/system/get-site-settings/?t=${timestamp}`, {
            headers: {
                'Cache-Control': 'no-cache, no-store, must-revalidate',
                'Pragma': 'no-cache',
                'Expires': '0'
            }
        });
        const data = await res.json();
        console.log('加载配置响应:', data);
        if (data.status === 'success') {
            const settings = data.settings;
            document.getElementById('smtpServer').value = settings.smtp_server || '';
            document.getElementById('smtpPort').value = settings.smtp_port || 587;
            document.getElementById('smtpEncryption').value = settings.smtp_encryption || 'tls';
            document.getElementById('smtpUsername').value = settings.smtp_username || '';
            document.getElementById('senderEmail').value = settings.sender_email || '';
            document.getElementById('maxMessages').value = settings.max_daily_messages || 100;
            document.getElementById('maxEmails').value = settings.max_daily_emails || 500;
            document.getElementById('dbHost').value = settings.db_host || 'localhost';
            document.getElementById('dbPort').value = settings.db_port || 5432;
            document.getElementById('dbName').value = settings.db_name || 'qsp';
            document.getElementById('pageTitle').value = settings.page_title || '';
            document.getElementById('siteName').value = settings.site_name || '';
            document.getElementById('siteDescription').value = settings.site_description || '';
            document.getElementById('primaryColor').value = settings.primary_color || '#667eea';
            document.getElementById('secondaryColor').value = settings.secondary_color || '#f5576c';
            document.getElementById('backgroundColor').value = settings.background_color || '#f5f7fa';
            
            // 显示logo预览
            if (settings.company_logo) {
                const logoPreview = document.getElementById('logoPreview');
                const logoUrl = `/media/${settings.company_logo}?t=${timestamp}`;
                logoPreview.src = logoUrl;
                logoPreview.style.display = 'block';
                console.log('显示logo预览:', logoUrl);
            } else {
                const logoPreview = document.getElementById('logoPreview');
                logoPreview.src = '';
                logoPreview.style.display = 'none';
                console.log('没有logo配置，隐藏预览');
            }
        } else {
            console.error('加载配置失败:', data.message);
        }
    } catch (err) {
        console.error('加载配置失败:', err);
    }
}

function saveConfig() {
    const data = {
        smtp_server: document.getElementById('smtpServer').value,
        smtp_port: parseInt(document.getElementById('smtpPort').value),
        smtp_encryption: document.getElementById('smtpEncryption').value,
        smtp_username: document.getElementById('smtpUsername').value,
        smtp_password: document.getElementById('smtpPassword').value,
        sender_email: document.getElementById('senderEmail').value,
        max_daily_messages: parseInt(document.getElementById('maxMessages').value),
        max_daily_emails: parseInt(document.getElementById('maxEmails').value),
        db_host: document.getElementById('dbHost').value,
        db_port: parseInt(document.getElementById('dbPort').value),
        db_name: document.getElementById('dbName').value,
        page_title: document.getElementById('pageTitle').value,
        site_name: document.getElementById('siteName').value,
        site_description: document.getElementById('siteDescription').value,
        primary_color: document.getElementById('primaryColor').value,
        secondary_color: document.getElementById('secondaryColor').value,
        background_color: document.getElementById('backgroundColor').value,
    };
    console.log('保存网站设置:', data);
    fetch('/api/system/save-site-settings/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
        credentials: 'include'
    })
    .then(res => {
        console.log('保存网站设置响应状态:', res.status);
        return res.json();
    })
    .then(data => {
        console.log('保存网站设置响应数据:', data);
        if (data.status === 'success') {
            alert('保存成功');
            // 重新加载配置，确保表单显示最新值
            loadConfig();
        } else {
            alert('保存失败: ' + data.message);
        }
    })
    .catch(err => {
        console.error('保存网站设置失败:', err);
        alert('保存失败: ' + err.message);
    });
}

function uploadLogo() {
    const fileInput = document.getElementById('logoFile');
    const file = fileInput.files[0];
    
    if (!file) {
        alert('请选择要上传的文件');
        return;
    }
    
    console.log('上传文件:', file);
    const formData = new FormData();
    formData.append('file', file);
    
    fetch('/api/system/upload-logo/', {
        method: 'POST',
        body: formData,
        credentials: 'include'
    })
    .then(res => {
        console.log('上传文件响应状态:', res.status);
        return res.json();
    })
    .then(data => {
        console.log('上传文件响应数据:', data);
        if (data.status === 'success') {
            alert('上传成功');
            // 更新logo预览
            const logoPreview = document.getElementById('logoPreview');
            const logoUrl = `/media/${data.file_path}`;
            logoPreview.src = logoUrl;
            logoPreview.style.display = 'block';
            console.log('更新logo预览:', logoUrl);
            // 重新加载配置，确保表单显示最新值
            loadConfig();
        } else {
            alert('上传失败: ' + data.message);
        }
    })
    .catch(err => {
        console.error('上传文件失败:', err);
        alert('上传失败: ' + err.message);
    });
}

function resetLogo() {
    console.log('重置企业图标');
    fetch('/api/system/reset-company-logo/', {
        method: 'POST',
        credentials: 'include'
    })
    .then(res => {
        console.log('重置企业图标响应状态:', res.status);
        return res.json();
    })
    .then(data => {
        console.log('重置企业图标响应数据:', data);
        if (data.status === 'success') {
            alert('重置成功');
            // 清除logo预览
            const logoPreview = document.getElementById('logoPreview');
            logoPreview.src = '';
            logoPreview.style.display = 'none';
            console.log('清除logo预览');
            // 重新加载配置，确保表单显示最新值
            loadConfig();
        } else {
            alert('重置失败: ' + data.message);
        }
    })
    .catch(err => {
        console.error('重置企业图标失败:', err);
        alert('重置失败: ' + err.message);
    });
}

loadConfig();
</script>
{% endblock %}