{% extends "base.html" %}
{% block title %}登录{% endblock %}
{% block content %}
<div class="row justify-content-center align-items-center" style="min-height: 80vh;">
    <div class="col-md-5">
        <div class="glass-card p-5">
            <div class="text-center mb-4">
                <h2 class="fw-bold" id="siteName" style="background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">质量安全平台</h2>
                <p class="text-secondary">QSP v0.0.1</p>
            </div>
            <form id="loginForm">
                <div class="mb-3">
                    <label class="form-label">用户名</label>
                    <input type="text" id="username" class="form-control form-control-lg" placeholder="请输入用户名" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">密码</label>
                    <input type="password" id="password" class="form-control form-control-lg" placeholder="请输入密码" required>
                </div>
                <div class="mb-4 form-check">
                    <input type="checkbox" class="form-check-input" id="remember">
                    <label class="form-check-label" for="remember">记住密码</label>
                </div>
                <div id="errorMsg" class="alert alert-danger d-none"></div>
                <button type="submit" class="btn btn-gradient w-100 btn-lg" id="loginBtn">登录</button>
            </form>
            <div class="mt-3 text-center">
                <small class="text-secondary">默认账号: admin / admin123</small>
            </div>
        </div>
    </div>
</div>

<script>
// 加载网站设置
async function loadSiteSettings() {
    try {
        // 添加时间戳参数，禁用缓存
        const timestamp = new Date().getTime();
        const res = await fetch(`/api/system/get-site-settings/?t=${timestamp}`, {
            headers: {
                'Cache-Control': 'no-cache, no-store, must-revalidate',
                'Pragma': 'no-cache',
                'Expires': '0'
            }
        });
        const data = await res.json();
        if (data.status === 'success') {
            const settings = data.settings;
            console.log('加载到的网站设置:', settings);
            
            // 应用网站标题
            if (settings.page_title) {
                document.title = `登录 - ${settings.page_title}`;
                console.log('更新页面标题为:', document.title);
            }
            
            // 应用网站名称
            if (settings.site_name) {
                // 更新指定元素
                const siteNameElement = document.getElementById('siteName');
                if (siteNameElement) {
                    siteNameElement.textContent = settings.site_name;
                    console.log('更新网站名称为:', settings.site_name);
                }
                
                // 替换页面中的"质量安全平台"文本
                const elements = document.querySelectorAll('*');
                elements.forEach(element => {
                    if (element.childNodes.length === 1 && element.firstChild.nodeType === Node.TEXT_NODE) {
                        if (element.textContent.includes('质量安全平台')) {
                            // 替换所有包含"质量安全平台"的文本，包括"质量安全平台jj"等变体
                            element.textContent = element.textContent.replace(/质量安全平台[\s\S]*/g, settings.site_name);
                            console.log('更新文本内容:', element.textContent);
                        }
                    }
                });
            }
        }
    } catch (err) {
        console.error('加载网站设置失败:', err);
    }
}

// 页面加载时加载网站设置
window.addEventListener('load', loadSiteSettings);

document.getElementById('loginForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    const errorDiv = document.getElementById('errorMsg');
    const loginBtn = document.getElementById('loginBtn');

    errorDiv.classList.add('d-none');
    loginBtn.disabled = true;
    loginBtn.innerHTML = '登录中...';

    try {
        const response = await fetch('/api/users/login/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password }),
            credentials: 'include'
        });
        const data = await response.json();
        if (response.ok) {
            window.location.href = '/';
        } else {
            errorDiv.textContent = data.error || '登录失败，请检查用户名和密码';
            errorDiv.classList.remove('d-none');
        }
    } catch (err) {
        errorDiv.textContent = '网络错误，请稍后重试';
        errorDiv.classList.remove('d-none');
    } finally {
        loginBtn.disabled = false;
        loginBtn.innerHTML = '登录';
    }
});
</script>
{% endblock %}