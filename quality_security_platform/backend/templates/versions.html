{% extends "base.html" %}
{% block active_versions %}active{% endblock %}
{% block title %}版本管理 - 质量安全平台{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="page-title">版本管理</h1>
    <button class="btn btn-gradient" data-bs-toggle="modal" data-bs-target="#versionModal" onclick="clearVersionForm()"><i class="fas fa-plus me-2"></i>新建发布版本</button>
</div>

<div class="glass-card p-4">
    <table class="table table-hover">
        <thead>
            <tr>
                <th>版本号</th>
                <th>创建时间</th>
                <th>封板时间</th>
                <th>状态</th>
                <th>代码质量</th>
                <th>登记应用数</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody id="versionTableBody"></tbody>
    </table>
</div>

<!-- 版本模态框（简略） -->
<div class="modal fade" id="versionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="versionModalTitle">新建发布版本</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="versionForm">
                    <input type="hidden" id="versionId">
                    <div class="mb-3">
                        <label class="form-label">版本号</label>
                        <input type="text" id="versionNumber" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">状态</label>
                        <select id="versionStatus" class="form-select">
                            <option value="developing">开发中</option>
                            <option value="released">已封板</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveVersion()">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 版本详情模态框 -->
<div class="modal fade" id="versionDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="versionDetailModalTitle">版本详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-4">
                    <h6 class="fw-semibold">版本信息</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>版本号：</strong><span id="detailVersionNumber"></span></p>
                            <p><strong>创建时间：</strong><span id="detailCreatedAt"></span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>封板时间：</strong><span id="detailReleasedAt"></span></p>
                            <p><strong>状态：</strong><span id="detailStatus"></span></p>
                        </div>
                    </div>
                </div>
                
                <div>
                    <h6 class="fw-semibold">登记的应用版本</h6>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>应用名称</th>
                                    <th>应用版本号</th>
                                </tr>
                            </thead>
                            <tbody id="registrationTableBody"></tbody>
                        </table>
                    </div>
                    <div id="noRegistrations" class="text-center text-muted mt-4" style="display: none;">
                        暂无应用版本登记
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<script>
async function fetchVersions() {
    const res = await fetch('/api/versions/', { credentials: 'include' });
    const data = await res.json();
    const versions = data.results || data;
    renderVersions(versions);
}

function renderVersions(versions) {
    const tbody = document.getElementById('versionTableBody');
    tbody.innerHTML = '';
    versions.forEach(v => {
        const statusClass = v.status === 'developing' ? 'bg-warning text-dark' : 'bg-secondary';
        const statusText = v.status === 'developing' ? '开发中' : '已封板';
        tbody.innerHTML += `
            <tr>
                <td class="fw-semibold"><a href="#" class="text-decoration-none" onclick="showVersionDetail(${v.id})"><i class="fas fa-info-circle me-1"></i>${v.version}</a></td>
                <td>${new Date(v.created_at).toLocaleDateString()}</td>
                <td>${v.released_at ? new Date(v.released_at).toLocaleDateString() : '--'}</td>
                <td><span class="badge ${statusClass}">${statusText}</span></td>
                <td>${v.code_quality?.quality_gate || '未扫描'}</td>
                <td>${v.registrations?.length || 0}</td>
                <td>
                    <button class="btn btn-sm btn-outline-secondary me-1" onclick="editVersion(${v.id})"><i class="fas fa-edit"></i></button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteVersion(${v.id})"><i class="fas fa-trash"></i></button>
                </td>
            </tr>
        `;
    });
}

async function showVersionDetail(versionId) {
    try {
        const res = await fetch(`/api/versions/${versionId}/`, { credentials: 'include' });
        const data = await res.json();
        
        if (data.status === 'success') {
            const version = data.data;
            
            // 填充版本信息
            document.getElementById('detailVersionNumber').textContent = version.version;
            document.getElementById('detailCreatedAt').textContent = new Date(version.created_at).toLocaleString();
            document.getElementById('detailReleasedAt').textContent = version.released_at ? new Date(version.released_at).toLocaleString() : '--';
            document.getElementById('detailStatus').textContent = version.status === 'developing' ? '开发中' : '已封板';
            
            // 填充登记的应用版本
            const registrationBody = document.getElementById('registrationTableBody');
            const noRegistrations = document.getElementById('noRegistrations');
            
            registrationBody.innerHTML = '';
            
            if (version.registrations && version.registrations.length > 0) {
                noRegistrations.style.display = 'none';
                version.registrations.forEach(reg => {
                    registrationBody.innerHTML += `
                        <tr>
                            <td>${reg.project}</td>
                            <td>${reg.app_version}</td>
                        </tr>
                    `;
                });
            } else {
                noRegistrations.style.display = 'block';
            }
            
            // 显示模态框
            new bootstrap.Modal(document.getElementById('versionDetailModal')).show();
        } else {
            alert('获取版本详情失败');
        }
    } catch (error) {
        console.error('获取版本详情失败:', error);
        alert('获取版本详情失败');
    }
}

function clearVersionForm() {
    document.getElementById('versionId').value = '';
    document.getElementById('versionNumber').value = '';
    document.getElementById('versionStatus').value = 'developing';
    document.getElementById('versionModalTitle').textContent = '新建发布版本';
}

function editVersion(id) {
    fetch(`/api/versions/${id}/`, { credentials: 'include' })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                const v = data.data;
                document.getElementById('versionId').value = v.id;
                document.getElementById('versionNumber').value = v.version;
                document.getElementById('versionStatus').value = v.status;
                document.getElementById('versionModalTitle').textContent = '编辑发布版本';
                new bootstrap.Modal(document.getElementById('versionModal')).show();
            } else {
                alert('获取版本信息失败');
            }
        });
}

function saveVersion() {
    const id = document.getElementById('versionId').value;
    const data = {
        version: document.getElementById('versionNumber').value,
        status: document.getElementById('versionStatus').value,
    };
    const url = id ? `/api/versions/${id}/` : '/api/versions/';
    const method = id ? 'PUT' : 'POST';
    fetch(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
        credentials: 'include'
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === 'success') {
            bootstrap.Modal.getInstance(document.getElementById('versionModal')).hide();
            fetchVersions();
        } else {
            alert('保存失败: ' + (data.message || '未知错误'));
        }
    });
}

function deleteVersion(id) {
    if (!confirm('确认删除该版本吗？')) return;
    fetch(`/api/versions/${id}/`, { method: 'DELETE', credentials: 'include' })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                fetchVersions();
            } else {
                alert('删除失败: ' + (data.message || '未知错误'));
            }
        });
}

fetchVersions();
</script>
{% endblock %}