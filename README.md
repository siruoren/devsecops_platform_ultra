- # 质量安全平台（QSP）项目需求说明书

  | 版本 | 日期       | 作者       | 变更内容                              |
  | :--- | :--------- | :--------- | :------------------------------------ |
  | V3.0 | 2026-02-13 | 系统架构师 | 新增 RBAC、CI/CD 流水线、风险评分系统 |
  | V2.0 | 2026-02-12 | 系统架构师 | 完善双活、主从同步、多数据库支持      |
  | V1.0 | 2026-02-10 | 系统架构师 | 初始版本（五大管理菜单）              |

  ------

  ## 1. 引言

  ### 1.1 项目背景

  随着企业软件交付规模持续增长，质量与安全已成为研发运维一体化（DevSecOps）的核心要素。当前组织面临以下挑战：

  - 应用信息、部署环境分散维护，缺乏统一视图；
  - 发布版本与代码质量、安全漏洞数据割裂，无法有效关联；
  - 软件成分分析（SCA）结果依赖人工导入，影响分析滞后；
  - CI/CD 流水线状态不透明，构建失败无自动通知；
  - 权限管理粗放，无法满足多角色精细化访问控制；
  - 缺乏量化的风险度量手段，无法动态评估项目健康度。

  为解决上述问题，建设**质量安全平台（Quality Security Platform, QSP）**，打造一体化的应用、版本、漏洞、流水线与风险管控平台，全面提升研发效能与系统安全性。

  ### 1.2 项目目标

  - **统一门户**：集中管理应用、部署环境、发布版本及应用版本登记。
  - **质量集成**：自动对接 SonarQube，实时同步代码质量指标。
  - **漏洞管控**：支持 Dependency-Check 报告导入、漏洞检索及项目‑工件关系图谱分析。
  - **版本影响分析**：当工件版本变更时，自动识别受影响应用并通知负责人。
  - **CI/CD 可视化**：记录流水线构建过程，多阶段状态可追溯，失败自动告警。
  - **风险量化**：基于代码质量、漏洞密度、构建成功率等维度，生成项目风险评分。
  - **权限精细**：实施 RBAC 模型，支持菜单、按钮、API 级别的权限控制。
  - **高可用架构**：支持单机、主从、双活三种部署模式，适配不同规模企业。

  ### 1.3 项目范围

  本项目涵盖以下功能模块：

  1. **用户管理** – 账户维护、个人信息自助、登录认证。
  2. **RBAC 权限系统** – 角色、权限、用户角色分配。
  3. **项目管理** – 应用信息、部署环境、负责人维护。
  4. **版本管理** – 发布版本生命周期、应用版本登记。
  5. **安全漏洞管理** – 代码质量查看、工件漏洞导入/检索、项目‑工件图谱、工件版本变更通知。
  6. **CI/CD 流水线管理** – 流水线定义、构建触发、阶段记录、失败通知。
  7. **风险评分系统** – 项目风险档案、风险评分、风险告警。
  8. **系统管理** – 动态配置（邮件、消息限额）、站内通知中心。

  ------

  ## 2. 总体描述

  ### 2.1 用户角色与权限

  基于 RBAC 模型，系统预置以下角色，并支持自定义角色：

  | 角色         | 权限描述                                    | 关联菜单/功能            |
  | :----------- | :------------------------------------------ | :----------------------- |
  | 系统管理员   | 所有权限，包括用户管理、RBAC 配置、系统配置 | 全部菜单                 |
  | 用户管理员   | 用户增删改查、角色分配                      | 用户管理                 |
  | 项目管理员   | 应用及环境维护                              | 项目管理                 |
  | 版本管理员   | 发布版本管理、应用版本登记                  | 版本管理                 |
  | 漏洞管理员   | 漏洞导入、检索、图谱查看                    | 安全漏洞管理             |
  | 开发人员     | 查看项目、版本、漏洞、流水线、风险看板      | 只读访问（部分菜单）     |
  | 测试人员     | 查看项目、版本、漏洞，并可导入漏洞报告      | 安全漏洞管理（导入权限） |
  | 流水线触发者 | 触发构建、查看构建日志                      | CI/CD 流水线             |
  | 风险查看者   | 查看风险评分及告警                          | 风险看板                 |

  权限控制粒度：**菜单可见性** + **按钮操作权限** + **API 接口权限**。

  ### 2.2 系统上下文

  

  

  ### 2.3 约束条件

  - **后端框架**：Python 3.9+ / Django 3.2 LTS，DRF。
  - **数据库**：支持 PostgreSQL、MySQL、SQLite，支持主从读写分离。
  - **部署模式**：单机 / 主从 / 双活（多数据中心）。
  - **容器化**：提供 Docker 镜像及 Docker Compose 编排。
  - **接口风格**：RESTful，JSON 格式，JWT 可选认证。
  - **前端**：本说明书仅定义后端 API，前端可分离实现（Vue/React）。

  ------

  ## 3. 功能需求

  ### 3.1 用户管理（菜单1）

  | 编号 | 功能点       | 详细描述                                                     |
  | :--- | :----------- | :----------------------------------------------------------- |
  | U01  | 用户新建     | 管理员填写用户名、邮箱、密码、姓名、部门、职位、头像，保存后密码加密存储。 |
  | U02  | 用户列表     | 分页展示用户列表，支持按用户名、邮箱、部门搜索。             |
  | U03  | 用户信息编辑 | 管理员可修改任意用户信息；普通用户仅能修改自己的邮箱、姓名、部门、职位、头像（不可改用户名）。 |
  | U04  | 密码修改     | 登录用户通过原密码验证后，可设置新密码（长度≥8位）。         |
  | U05  | 登录/注销    | 用户名+密码登录，返回用户基本信息及权限标识；支持 Session 认证及 JWT 扩展。 |
  | U06  | 个人中心     | 查看本人信息及权限概览。                                     |

  ### 3.2 RBAC 权限系统（菜单1.1）

  | 编号 | 功能点       | 详细描述                                                     |
  | :--- | :----------- | :----------------------------------------------------------- |
  | R01  | 权限管理     | 维护权限资源（权限代码、名称、所属模块、是否为菜单、父权限）。系统初始化时自动导入默认权限。 |
  | R02  | 角色管理     | 角色增删改查，角色可关联多个权限。预置角色：系统管理员、开发人员、测试人员等。 |
  | R03  | 用户角色分配 | 为用户分配一个或多个角色；支持批量分配/移除。                |
  | R04  | 权限校验     | 前端根据用户权限动态渲染菜单；后端 API 通过权限装饰器进行接口级鉴权。 |

  ### 3.3 项目管理（菜单2）

  | 编号 | 功能点       | 详细描述                                                     |
  | :--- | :----------- | :----------------------------------------------------------- |
  | P01  | 部署环境管理 | 维护部署环境，字段：环境名、服务器 IP 列表（逗号分隔）。     |
  | P02  | 应用信息管理 | 字段：应用名、Git仓库地址、仓库内路径、所属环境、部署目录、启停脚本、启停Cron、SonarQube项目地址、负责人。 |
  | P03  | 应用检索     | 支持按应用名、仓库地址、环境、负责人模糊搜索。               |
  | P04  | 负责人关联   | 负责人从用户库中选择（单选）。                               |

  ### 3.4 版本管理（菜单3）

  | 编号 | 功能点           | 详细描述                                                     |
  | :--- | :--------------- | :----------------------------------------------------------- |
  | V01  | 发布版本维护     | 版本号唯一，自动记录创建时间；状态：开发中、已封板；封板时手动填写封板时间。 |
  | V02  | 状态变更 API     | 提供 API 修改版本状态（开发中 → 已封板）。                   |
  | V03  | 代码质量写入 API | 接收 SonarQube 扫描结果（JSON），存储至版本记录的 `code_quality` 字段。 |
  | V04  | 应用版本登记     | 在发布版本详情页选择应用并填写该应用在此版本中的版本号。     |
  | V05  | 登记信息修改     | 仅允许本人或管理员修改登记记录。                             |
  | V06  | 版本详情展示     | 点击版本号进入详情页，展示该版本下所有登记的应用及应用版本，支持按应用名搜索。 |

  ### 3.5 安全漏洞管理（菜单4）

  #### 3.5.1 代码质量

  | 编号 | 功能点   | 详细描述                                                     |
  | :--- | :------- | :----------------------------------------------------------- |
  | SQ01 | 项目筛选 | 按项目名称关键词匹配，过滤项目列表。                         |
  | SQ02 | 质量展示 | 展示所选项目最近一次 SonarQube 扫描的 Bugs、漏洞、代码异味、覆盖率等。 |

  #### 3.5.2 工件漏洞

  | 编号 | 功能点            | 详细描述                                                     |
  | :--- | :---------------- | :----------------------------------------------------------- |
  | AV01 | 漏洞结果导入      | **页面**：选择项目，上传 Dependency-Check JSON 文件。 **API**：接收 JSON 内容，异步解析并存储 `ArtifactVulnerability`。 |
  | AV02 | 漏洞检索          | 支持按项目名、工件名、工件版本号关键词搜索，分页展示漏洞列表。 |
  | AV03 | 项目‑工件关系图谱 | 以项目为中心，展示其所有依赖工件节点，节点颜色按漏洞严重性着色（绿/蓝/橙/红/深红）。鼠标悬浮/点击显示漏洞详情。 |
  | AV04 | 工件‑项目关系图谱 | 以工件为中心，展示该工件被哪些项目引用（跨项目影响分析）。点击项目节点，浮层显示该项目登记的应用名称、版本、负责人及所在发布版本。 |
  | AV05 | 工件版本变更通知  | 申请人选择**发布版本**，填写工件组织名、工件名、新版本号，选择通知方式（站内信/邮件/两者）。 |
  |      |                   | 系统检索该发布版本下所有登记的应用，分析依赖关系（需预置或集成依赖解析），向受影响应用的负责人发送通知。 |

  ### 3.6 CI/CD 流水线管理（菜单5）

  | 编号 | 功能点           | 详细描述                                                     |
  | :--- | :--------------- | :----------------------------------------------------------- |
  | C01  | 流水线定义       | 维护流水线名称、关联项目、描述；支持多个阶段，每个阶段定义名称、执行顺序、脚本、超时时间。 |
  | C02  | 构建触发         | 手动触发流水线，传入版本/分支标识；生成唯一 Build ID，状态流转：pending → running → success/failed/aborted。 |
  | C03  | 阶段执行记录     | 记录每个阶段的开始/结束时间、状态、日志片段。                |
  | C04  | 构建历史         | 查看所有构建记录，支持按流水线、状态、时间过滤，可查看详细日志。 |
  | C05  | 构建失败自动通知 | 构建失败时，自动向触发人发送站内消息（及邮件，若配置）。     |
  | C06  | SonarQube 集成   | 构建阶段可触发 Sonar 扫描，任务完成后回写质量关结果至构建记录。 |

  ### 3.7 风险评分系统（菜单6）

  | 编号 | 功能点   | 详细描述                                                     |
  | :--- | :------- | :----------------------------------------------------------- |
  | R01  | 风险档案 | 每个项目对应一份风险档案，包含：综合风险分(0~100)、代码质量分、漏洞风险分、流水线健康分。 |
  | R02  | 评分算法 | 综合分 = 代码质量分×0.3 + 漏洞风险分×0.4 + 流水线健康分×0.3。 各分项由 Sonar 指标、漏洞数量/严重性、构建成功率等计算。 |
  | R03  | 风险看板 | 以列表/卡片形式展示所有项目的风险评分及趋势。                |
  | R04  | 风险告警 | 当风险分超过阈值（如≥70）时，自动生成风险告警记录，并通知项目负责人。 |

  ### 3.8 系统管理（菜单7）

  | 编号 | 功能点           | 详细描述                                                     |
  | :--- | :--------------- | :----------------------------------------------------------- |
  | S01  | 动态配置         | 基于 django-constance，支持在线修改：每日最大站内信、每日最大邮件数、SMTP 配置、SonarQube 地址等。 |
  | S02  | 站内通知中心     | 用户查看个人通知列表，支持标为已读、批量已读、删除；顶部导航显示未读数量。 |
  | S03  | 邮件发送         | 集成 SMTP，发送各类通知邮件，受每日限额控制。                |
  | S04  | 审计日志（扩展） | （可选）记录用户关键操作。                                   |

  ------

  ## 4. 非功能需求

  ### 4.1 性能指标

  - **并发支持**：核心 API 支持 ≥200 并发用户，响应时间 95% ≤500ms。
  - **图谱渲染**：500 节点内关系图加载时间 ≤5 秒。
  - **导入任务**：Dependency-Check JSON 文件（≤50MB）解析时间 ≤30 秒（异步）。
  - **数据库**：单表数据量达千万级时，主要查询仍应在 1 秒内返回（需合理索引）。

  ### 4.2 安全性

  - **认证**：密码 PBKDF2 加密，Session 过期时间可配置；支持 JWT 扩展。
  - **权限**：所有 API 均需鉴权，未授权返回 401/403。
  - **防攻击**：Django 内置 CSRF、XSS、SQL 注入防护；CORS 严格配置。
  - **敏感数据**：数据库连接串、邮件密码在配置文件中加密存储（使用 `django-cryptography`）。

  ### 4.3 可用性与可靠性

  - **主从切换**：数据库读库故障时，读流量自动切换至主库（或另一从库），服务不中断。
  - **双活支持**：两个数据中心同时提供读写服务，任一数据中心故障，流量全切至另一中心。
  - **任务可靠性**：Celery 任务持久化，失败自动重试（最多3次），关键任务记录重试日志。
  - **健康检查**：提供 `/health/` 接口，返回数据库、缓存、队列状态。

  ### 4.4 可维护性

  - **配置分离**：所有环境配置通过 `.env` 文件注入，不硬编码。
  - **日志规范**：结构化 JSON 日志，包含请求ID、用户、操作耗时；支持 ELK 收集。
  - **文档完备**：Swagger 自动生成 API 文档，更新及时。
  - **模块化**：各功能拆分为独立 Django App，依赖清晰。

  ### 4.5 可扩展性

  - **数据库**：支持动态增加从库，修改路由器配置即可。
  - **CI/CD 集成**：预留 Webhook 接口，便于对接 Jenkins、GitLab CI。
  - **漏洞源扩展**：可增加对 Trivy、Grype 等扫描器的支持。

  ------

  ## 5. 技术架构

  ### 5.1 整体架构图

  

  

  ### 5.2 技术栈选型

  | 组件          | 选型                                   | 说明                                |
  | :------------ | :------------------------------------- | :---------------------------------- |
  | 后端框架      | Django 3.2 LTS + Django REST Framework | 成熟稳定，ORM 强大                  |
  | 数据库        | PostgreSQL 14 / MySQL 8 / SQLite       | 主从配置，读写分离                  |
  | 缓存/消息队列 | Redis 7                                | 缓存 Session，Celery Broker/Backend |
  | 异步任务      | Celery 5                               | 执行耗时任务（导入、通知、评分）    |
  | API 文档      | drf-yasg / Swagger                     | 自动生成 OpenAPI 3.0                |
  | 动态配置      | django-constance                       | 支持数据库/Redis 后端               |
  | 权限          | 自定义 RBAC + drf 权限类               | 细粒度权限控制                      |
  | 序列化        | DRF serializers                        | -                                   |
  | 部署          | Docker + Docker Compose                | 多环境编排                          |
  | 监控          | Flower (Celery) + Health Check         | -                                   |

  ### 5.3 数据模型核心设计

  - **用户**：继承 `AbstractUser`，扩展部门、职位等字段。
  - **权限**：`Permission`（code, name, module, is_menu, parent）。
  - **角色**：`Role`（name, code），多对多 `Permission`。
  - **用户角色**：`UserRole`（user, role）。
  - **项目**：`Project`，外键 `Environment`、`User`（负责人）。
  - **发布版本**：`ReleaseVersion`，一对多 `VersionRegistration`。
  - **漏洞扫描**：`DependencyCheckScan`，一对多 `ArtifactVulnerability`。
  - **流水线**：`Pipeline` → `PipelineStage` → `BuildRecord` → `BuildStageRecord`。
  - **风险档案**：`RiskProfile`（一对一 Project），`RiskAlert`。
  - **通知**：`Notification`。

  详细 ER 图见附录。

  ------

  ## 6. 部署方案

  ### 6.1 单机开发模式

  - 使用 SQLite + Redis（可选），`docker-compose.yml` 启动 Web + Redis + Celery。
  - 适用于本地快速开发测试。

  ### 6.2 生产主从模式（推荐）

  - PostgreSQL 主从异步复制，Redis 主从。
  - Django 配置 `DATABASE_ROUTERS = ['config.database_router.MasterSlaveRouter']`。
  - Web 节点水平扩展，Nginx 负载均衡。

  ### 6.3 双活多数据中心模式

  - 每个数据中心部署一套完整主从数据库。
  - 应用层双写（同时写入两个中心主库）或数据库层同步（如 PostgreSQL BDR）。
  - 读请求根据用户所属数据中心就近路由。
  - 需定制 `ActiveActiveRouter`，并解决数据冲突策略。

  ------

  ## 7. 验收标准

  1. **功能完整**：所有功能模块通过测试用例，覆盖率达到 90% 以上。
  2. **接口正确**：Swagger 文档与实际接口完全一致，可在线调试。
  3. **权限有效**：不同角色登录后菜单及操作符合权限配置。
  4. **性能达标**：符合 4.1 节性能指标。
  5. **高可用**：主从切换测试中，读服务中断时间 <10 秒。
  6. **部署成功**：提供三种数据库的 Docker Compose 文件，执行后系统可正常运行。
  7. **文档齐全**：需求说明书、API 文档、部署手册完备。

  ------

  ## 8. 附录

  ### 8.1 术语表

  | 术语             | 解释                                            |
  | :--------------- | :---------------------------------------------- |
  | RBAC             | 基于角色的访问控制（Role-Based Access Control） |
  | SonarQube        | 开源代码质量管理平台                            |
  | Dependency-Check | OWASP 软件成分分析工具，检测开源组件漏洞        |
  | SCA              | 软件成分分析（Software Composition Analysis）   |
  | Build ID         | 全局唯一构建标识，UUID 格式                     |
  | 风险评分         | 0~100 数值，越高代表风险越大                    |

  ### 8.2 参考文档

  - Django 3.2 官方文档
  - Django REST Framework 3.14
  - Celery 5.2 用户指南
  - PostgreSQL 主从复制配置

  ------

  **文档修订记录**

  | 版本 | 日期       | 修改说明                   | 作者       |
  | :--- | :--------- | :------------------------- | :--------- |
  | V3.0 | 2026-02-13 | 新增 RBAC、CI/CD、风险评分 | 系统架构师 |
  | V2.0 | 2026-02-12 | 完善数据库主从、双活描述   | 系统架构师 |
  | V1.0 | 2026-02-10 | 初始版本                   | 产品经理   |

  ------

  
## Star History

[![Star History Chart](https://api.star-history.com/svg?repos=siruoren/devsecops_platform_ultra&type=Date)](https://www.star-history.com/#siruoren/devsecops_platform_ultra&Date)